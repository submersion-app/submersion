# Fastfile for Submersion App Store Automation
#
# Usage:
#   bundle exec fastlane screenshots        # Capture screenshots
#   bundle exec fastlane upload_screenshots # Upload screenshots to App Store Connect
#   bundle exec fastlane capture_and_upload # Both in one command
#
#   bundle exec fastlane build              # Build IPA for App Store
#   bundle exec fastlane beta               # Build + upload to TestFlight
#   bundle exec fastlane release            # Build + upload to App Store
#   bundle exec fastlane full_release       # Screenshots + build + upload
#
#   Signing is handled automatically via Xcode + App Store Connect API key.

default_platform(:ios)

platform :ios do
  # ============================================================================
  # Screenshot Lanes
  # ============================================================================

  desc "Capture App Store screenshots on iPhone and iPad simulators"
  lane :screenshots do
    UI.message("Starting screenshot capture...")

    # Run the capture script from project root
    sh("cd ../.. && ./scripts/release/capture_screenshots.sh")

    UI.success("Screenshots captured successfully!")
    UI.message("Screenshots saved to: ../../screenshots/")
  end

  desc "Upload screenshots to App Store Connect"
  lane :upload_screenshots do
    # iOS screenshots are in their own directory to avoid "Display Type Not Allowed!"
    # errors from mixing iOS and macOS resolutions in the same Fastlane screenshots path
    screenshots_path = File.absolute_path("../../screenshots/ios")

    unless File.directory?(screenshots_path)
      UI.user_error!("iOS screenshots directory not found at #{screenshots_path}. Run 'fastlane screenshots' first.")
    end

    # Load API key - prefer environment variables, fall back to JSON file
    api_key = load_api_key

    UI.message("Uploading screenshots to App Store Connect...")

    upload_to_app_store(
      api_key: api_key,
      skip_binary_upload: true,
      skip_metadata: true,
      skip_app_version_update: true,
      screenshots_path: screenshots_path,
      overwrite_screenshots: true,
      ignore_language_directory_validation: true,  # We have device folders alongside locale folders
      precheck_include_in_app_purchases: false,    # API key auth doesn't support IAP precheck
      force: true,                                 # Skip HTML preview and y/n confirmation prompt
    )

    UI.success("Screenshots uploaded successfully!")
  end

  # ============================================================================
  # Helper Methods
  # ============================================================================

  # Loads API key from environment variables or falls back to api_key.json
  def load_api_key
    # Check for environment variables first (preferred for CI)
    if ENV["APP_STORE_CONNECT_API_KEY_KEY_ID"] &&
       ENV["APP_STORE_CONNECT_API_KEY_ISSUER_ID"] &&
       ENV["APP_STORE_CONNECT_API_KEY_KEY_FILEPATH"]

      UI.message("Using API key from environment variables")
      return app_store_connect_api_key(
        key_id: ENV["APP_STORE_CONNECT_API_KEY_KEY_ID"],
        issuer_id: ENV["APP_STORE_CONNECT_API_KEY_ISSUER_ID"],
        key_filepath: ENV["APP_STORE_CONNECT_API_KEY_KEY_FILEPATH"],
        in_house: false
      )
    end

    # Fall back to JSON file for local development
    json_path = "fastlane/api_key.json"
    if File.exist?(json_path)
      UI.message("Using API key from api_key.json")
      config = JSON.parse(File.read(json_path))
      return app_store_connect_api_key(
        key_id: config["key_id"],
        issuer_id: config["issuer_id"],
        key_filepath: config["key_filepath"],
        in_house: config["in_house"] || false
      )
    end

    UI.user_error!(
      "No API key found. Either set environment variables:\n" \
      "  APP_STORE_CONNECT_API_KEY_KEY_ID\n" \
      "  APP_STORE_CONNECT_API_KEY_ISSUER_ID\n" \
      "  APP_STORE_CONNECT_API_KEY_KEY_FILEPATH\n" \
      "Or create fastlane/api_key.json"
    )
  end

  # Ensures the selected Xcode/iOS SDK meets App Store Connect requirements.
  def ensure_required_ios_build_tools
    required_xcode_major = 26
    required_ios_sdk_major = 26

    xcode_version_output = sh("xcodebuild -version", log: false)
    xcode_version_match = xcode_version_output.match(/Xcode\s+(\d+(?:\.\d+)?)/)
    unless xcode_version_match
      UI.user_error!(
        "Unable to detect Xcode version from `xcodebuild -version` output:\n#{xcode_version_output}"
      )
    end

    xcode_version = xcode_version_match[1]
    xcode_major = xcode_version.split(".").first.to_i
    if xcode_major < required_xcode_major
      UI.user_error!(
        "Xcode #{required_xcode_major}+ is required for App Store uploads. " \
        "Current Xcode: #{xcode_version}. Install Xcode #{required_xcode_major}+ and " \
        "set it with `xcode-select`."
      )
    end

    ios_sdk_version = sh("xcrun --sdk iphoneos --show-sdk-version", log: false).strip
    if ios_sdk_version.empty?
      UI.user_error!("Unable to detect active iPhoneOS SDK from `xcrun --sdk iphoneos --show-sdk-version`.")
    end
    ios_sdk_major = ios_sdk_version.split(".").first.to_i
    if ios_sdk_major < required_ios_sdk_major
      UI.user_error!(
        "iOS SDK #{required_ios_sdk_major}+ is required for App Store uploads. " \
        "Current SDK: #{ios_sdk_version}. Install Xcode #{required_xcode_major}+."
      )
    end

    UI.message("Using Xcode #{xcode_version} with iOS SDK #{ios_sdk_version}")
  end

  desc "Capture screenshots and upload to App Store Connect"
  lane :capture_and_upload do
    screenshots
    upload_screenshots
  end

  # ============================================================================
  # Build Lanes
  # ============================================================================

  desc "Build the iOS app for App Store distribution"
  lane :build do
    ensure_required_ios_build_tools

    # Ensure CocoaPods dependencies are up to date
    UI.message("Running pod install...")
    cocoapods(
      podfile: "./Podfile",
      try_repo_update_on_error: true
    )

    api_key = load_api_key

    # Build the Flutter app (version comes from pubspec.yaml -> Generated.xcconfig -> Info.plist)
    UI.message("Building Flutter app...")
    sh("cd ../.. && flutter build ios --release --no-codesign")

    # Build and sign the IPA
    UI.message("Building and signing IPA...")
    key_path = File.expand_path(ENV["APP_STORE_CONNECT_API_KEY_KEY_FILEPATH"], "..")
    auth_flags = "-allowProvisioningUpdates" \
      " -authenticationKeyPath '#{key_path}'" \
      " -authenticationKeyID '#{ENV["APP_STORE_CONNECT_API_KEY_KEY_ID"]}'" \
      " -authenticationKeyIssuerID '#{ENV["APP_STORE_CONNECT_API_KEY_ISSUER_ID"]}'" \
      " CODE_SIGN_IDENTITY='Apple Distribution'"

    build_ios_app(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      export_method: "app-store",
      output_directory: "./build",
      output_name: "Submersion.ipa",
      export_options: {
        signingStyle: "automatic",
        teamID: "8U3RSKF42Q",
        manageAppVersionAndBuildNumber: false
      },
      xcargs: auth_flags,
    )

    UI.success("Build complete! IPA saved to ios/build/Submersion.ipa")
  end

  # ============================================================================
  # Upload Lanes
  # ============================================================================

  desc "Build and upload to TestFlight for beta testing"
  lane :beta do
    build

    api_key = load_api_key

    UI.message("Uploading to TestFlight...")
    upload_to_testflight(
      api_key: api_key,
      ipa: "./build/Submersion.ipa",
      skip_waiting_for_build_processing: true
    )

    UI.success("Build uploaded to TestFlight! It will be available for testing once processing completes.")
  end

  desc "Build and upload to App Store for production release"
  lane :release do
    build

    api_key = load_api_key

    UI.message("Uploading to App Store Connect...")
    upload_to_app_store(
      api_key: api_key,
      ipa: "./build/Submersion.ipa",
      skip_screenshots: true,        # Upload screenshots separately
      skip_metadata: true,           # Set to false to upload metadata from fastlane/metadata/
      submit_for_review: false,      # Set to true to auto-submit for review
      automatic_release: false,      # Set to true to auto-release when approved
      precheck_include_in_app_purchases: false
    )

    UI.success("Build uploaded to App Store Connect!")
  end

  desc "Full release: capture screenshots, upload everything, and submit build"
  lane :full_release do
    screenshots
    upload_screenshots
    release
  end

  # ============================================================================
  # Utility Lanes
  # ============================================================================

  desc "Clean up screenshot directories"
  lane :clean_screenshots do
    screenshots_path = "../../screenshots"

    if File.directory?(screenshots_path)
      FileUtils.rm_rf(screenshots_path)
      UI.success("Cleaned screenshots directory")
    else
      UI.message("No screenshots directory to clean")
    end
  end

  desc "List available simulators for screenshots"
  lane :list_simulators do
    UI.message("Available iPhone simulators:")
    sh("xcrun simctl list devices available | grep iPhone | head -10")

    UI.message("\nAvailable iPad simulators:")
    sh("xcrun simctl list devices available | grep iPad | head -10")
  end

  desc "Clean build artifacts"
  lane :clean do
    # Clean Flutter build
    sh("cd ../.. && flutter clean")

    # Clean Xcode derived data
    clear_derived_data

    # Clean local build output
    build_path = "./build"
    if File.directory?(build_path)
      FileUtils.rm_rf(build_path)
      UI.message("Cleaned build directory")
    end

    UI.success("All build artifacts cleaned!")
  end

  desc "Show all available lanes"
  lane :lanes_help do
    UI.message("Available Fastlane lanes:")
    UI.message("")
    UI.message("  Screenshots:")
    UI.message("    screenshots        - Capture App Store screenshots")
    UI.message("    upload_screenshots - Upload screenshots to App Store Connect")
    UI.message("    capture_and_upload - Both in one command")
    UI.message("")
    UI.message("  Build & Release:")
    UI.message("    build              - Build IPA for App Store")
    UI.message("    beta               - Build + upload to TestFlight")
    UI.message("    release            - Build + upload to App Store")
    UI.message("    full_release       - Screenshots + build + upload")
    UI.message("")
    UI.message("  Utilities:")
    UI.message("    clean              - Clean all build artifacts")
    UI.message("    clean_screenshots  - Clean screenshot directory")
    UI.message("    list_simulators    - List available simulators")
    UI.message("    lanes_help         - Show this help")
  end
end
