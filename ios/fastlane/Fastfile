# Fastfile for Submersion App Store Automation
#
# Usage:
#   bundle exec fastlane screenshots       # Capture screenshots
#   bundle exec fastlane upload_screenshots # Upload to App Store Connect
#   bundle exec fastlane capture_and_upload # Both in one command

default_platform(:ios)

platform :ios do
  # ============================================================================
  # Screenshot Lanes
  # ============================================================================

  desc "Capture App Store screenshots on iPhone and iPad simulators"
  lane :screenshots do
    UI.message("Starting screenshot capture...")

    # Run the capture script from project root
    sh("cd ../.. && ./scripts/capture_screenshots.sh")

    UI.success("Screenshots captured successfully!")
    UI.message("Screenshots saved to: ../../screenshots/")
  end

  desc "Upload screenshots to App Store Connect"
  lane :upload_screenshots do
    # Check if screenshots exist
    screenshots_path = File.absolute_path("../../screenshots")

    unless File.directory?(screenshots_path)
      UI.user_error!("Screenshots directory not found at #{screenshots_path}. Run 'fastlane screenshots' first.")
    end

    # Load API key - prefer environment variables, fall back to JSON file
    api_key = load_api_key

    UI.message("Uploading screenshots to App Store Connect...")

    upload_to_app_store(
      api_key: api_key,
      skip_binary_upload: true,
      skip_metadata: true,
      skip_app_version_update: true,
      screenshots_path: screenshots_path,
      overwrite_screenshots: true,
      ignore_language_directory_validation: true,  # We have device folders alongside locale folders
    )

    UI.success("Screenshots uploaded successfully!")
  end

  # ============================================================================
  # Helper Methods
  # ============================================================================

  # Loads API key from environment variables or falls back to api_key.json
  def load_api_key
    # Check for environment variables first (preferred for CI)
    if ENV["APP_STORE_CONNECT_API_KEY_KEY_ID"] &&
       ENV["APP_STORE_CONNECT_API_KEY_ISSUER_ID"] &&
       ENV["APP_STORE_CONNECT_API_KEY_KEY_FILEPATH"]

      UI.message("Using API key from environment variables")
      return app_store_connect_api_key(
        key_id: ENV["APP_STORE_CONNECT_API_KEY_KEY_ID"],
        issuer_id: ENV["APP_STORE_CONNECT_API_KEY_ISSUER_ID"],
        key_filepath: ENV["APP_STORE_CONNECT_API_KEY_KEY_FILEPATH"],
        in_house: false
      )
    end

    # Fall back to JSON file for local development
    json_path = "fastlane/api_key.json"
    if File.exist?(json_path)
      UI.message("Using API key from api_key.json")
      config = JSON.parse(File.read(json_path))
      return app_store_connect_api_key(
        key_id: config["key_id"],
        issuer_id: config["issuer_id"],
        key_filepath: config["key_filepath"],
        in_house: config["in_house"] || false
      )
    end

    UI.user_error!(
      "No API key found. Either set environment variables:\n" \
      "  APP_STORE_CONNECT_API_KEY_KEY_ID\n" \
      "  APP_STORE_CONNECT_API_KEY_ISSUER_ID\n" \
      "  APP_STORE_CONNECT_API_KEY_KEY_FILEPATH\n" \
      "Or create fastlane/api_key.json"
    )
  end

  desc "Capture screenshots and upload to App Store Connect"
  lane :capture_and_upload do
    screenshots
    upload_screenshots
  end

  # ============================================================================
  # Utility Lanes
  # ============================================================================

  desc "Clean up screenshot directories"
  lane :clean_screenshots do
    screenshots_path = "../../screenshots"

    if File.directory?(screenshots_path)
      FileUtils.rm_rf(screenshots_path)
      UI.success("Cleaned screenshots directory")
    else
      UI.message("No screenshots directory to clean")
    end
  end

  desc "List available simulators for screenshots"
  lane :list_simulators do
    UI.message("Available iPhone simulators:")
    sh("xcrun simctl list devices available | grep iPhone | head -10")

    UI.message("\nAvailable iPad simulators:")
    sh("xcrun simctl list devices available | grep iPad | head -10")
  end
end
