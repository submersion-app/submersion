#!/bin/bash

# Pre-push hook for Submersion
# Runs dart format check, flutter analyze, and tests before pushing

set -e

echo "ğŸ” Running pre-push checks..."
echo ""

# Get the project root (where this hook lives)
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"

cd "$PROJECT_ROOT"

# Check dart format
echo "ğŸ“ Checking code formatting..."
if ! dart format --set-exit-if-changed . > /dev/null 2>&1; then
    echo "âŒ Format check failed!"
    echo ""
    echo "The following files need formatting:"
    dart format --set-exit-if-changed . 2>&1 || true
    echo ""
    echo "Run 'dart format lib/ test/' to fix formatting issues."
    exit 1
fi
echo "âœ… Format check passed"
echo ""

# Run flutter analyze
echo "ğŸ”¬ Running flutter analyze..."
if ! flutter analyze; then
    echo ""
    echo "âŒ Analysis failed! Fix the issues above before pushing."
    exit 1
fi
echo "âœ… Analysis passed"
echo ""

# Run tests
echo "ğŸ§ª Running tests..."
if ! flutter test --exclude-tags performance; then
    echo ""
    echo "âŒ Tests failed! Fix the failing tests before pushing."
    exit 1
fi
echo "âœ… All tests passed"
echo ""

echo "ğŸš€ All checks passed! Pushing..."
exit 0
